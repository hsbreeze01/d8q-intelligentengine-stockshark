# 股票分析系统设计文档

## 1. Architecture Overview

本股票分析系统采用分层架构设计，确保系统的可维护性、可扩展性和可测试性。系统分为以下几个层次：

### 1.1 系统架构图
```
┌─────────────────────────────────────────────────────────────────┐
│                        前端展示层                                │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │
│  │   股票分析模块   │  │   主题筛选模块   │  │   场景分析模块   │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  │
└───────────────────────┬─────────────────────────────────────────┘
                        │
┌───────────────────────▼─────────────────────────────────────────┐
│                        API层                                     │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │
│  │  Stock API      │  │  Theme API      │  │  Scenario API   │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  │
└───────────────────────┬─────────────────────────────────────────┘
                        │
┌───────────────────────▼─────────────────────────────────────────┐
│                        业务逻辑层                                │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │
│  │  单股票分析引擎  │  │  主题筛选引擎   │  │  场景分析引擎   │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │
│  │  规则管理模块   │  │  数据处理模块   │  │  NLP分析模块    │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  │
└───────────────────────┬─────────────────────────────────────────┘
                        │
┌───────────────────────▼─────────────────────────────────────────┐
│                        数据层                                     │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │
│  │  股票数据存储   │  │  规则配置存储   │  │  分析结果存储   │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │
│  │  akshare数据源  │  │  context7 API   │  │  外部数据源     │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

### 1.2 技术栈选择
- **后端框架**: Flask (轻量级、高性能、易于扩展)
- **前端框架**: React (组件化开发、响应式设计)
- **数据库**: 
  - MySQL (结构化数据存储，如股票基本信息、财务数据)
  - MongoDB (非结构化数据存储，如新闻、分析结果)
- **数据获取**: akshare (股票数据)、context7 API (参考数据)
- **自然语言处理**: HanLP (中文文本分析)、spaCy (英文文本分析)
- **数据处理**: pandas、numpy
- **可视化**: ECharts、Plotly
- **API文档**: Swagger/OpenAPI

## 2. System Components

### 2.1 数据层组件

#### 2.1.1 数据源模块
- **akshare数据源**: 负责获取股票基本信息、行情数据、财务数据等
- **context7 API**: 提供参考数据和补充信息
- **外部数据源**: 新闻媒体数据、行业报告等

#### 2.1.2 数据存储模块
- **股票数据存储**: 存储股票基本信息、行情数据、财务数据等结构化数据
- **规则配置存储**: 存储用户自定义的分析规则和筛选条件
- **分析结果存储**: 存储历史分析结果和用户查询记录

### 2.2 业务逻辑层组件

#### 2.2.1 单股票分析引擎
- **股票信息获取**: 从akshare获取股票基本信息和历史数据
- **规则分析执行**: 根据用户设定的规则执行分析
- **投资价值评估**: 综合多个维度评估股票投资价值
- **风险分析**: 识别和评估股票的各种风险因素

#### 2.2.2 主题筛选引擎
- **主题/行业分类**: 管理股票的主题和行业分类
- **筛选条件处理**: 处理用户设定的多条件筛选
- **排序算法**: 实现多种排序规则
- **结果生成**: 生成筛选后的股票列表和关键指标

#### 2.2.3 场景分析引擎
- **文本分析**: 对输入的场景或新闻进行文本分析
- **实体识别**: 识别文本中的关键实体（公司、产品等）
- **供应链分析**: 构建实体之间的供应链关系图谱
- **上市状态查询**: 查询企业是否上市
- **股权结构分析**: 分析企业的股权结构

#### 2.2.4 规则管理模块
- **规则定义**: 支持用户自定义分析规则
- **规则存储**: 持久化存储规则配置
- **规则执行**: 解析和执行规则

#### 2.2.5 数据处理模块
- **数据清洗**: 清洗和预处理原始数据
- **数据转换**: 将数据转换为分析所需的格式
- **数据整合**: 整合来自多个数据源的数据
- **指标计算**: 计算各种财务和技术指标

#### 2.2.6 NLP分析模块
- **文本分词**: 对中文和英文文本进行分词
- **实体识别**: 识别文本中的实体（公司、产品、地点等）
- **关系抽取**: 抽取实体之间的关系
- **情感分析**: 分析文本的情感倾向

### 2.3 API层组件

#### 2.3.1 Stock API
- **/api/stock/{code}**: 获取股票基本信息
- **/api/stock/{code}/analysis**: 执行单股票分析
- **/api/stock/{code}/rules**: 获取/设置股票分析规则

#### 2.3.2 Theme API
- **/api/themes**: 获取所有主题列表
- **/api/themes/{theme}/stocks**: 获取主题相关股票
- **/api/industries**: 获取所有行业列表
- **/api/industries/{industry}/stocks**: 获取行业相关股票
- **/api/stocks/filter**: 执行股票筛选

#### 2.3.3 Scenario API
- **/api/scenario/analyze**: 分析场景或新闻
- **/api/entities/{entity}/supply-chain**: 获取实体的供应链信息
- **/api/companies/{company}/status**: 查询公司上市状态

### 2.4 前端展示层组件

#### 2.4.1 股票分析模块
- **股票查询界面**: 输入股票代码或名称查询
- **分析结果展示**: 展示投资价值评分和风险分析
- **规则设置界面**: 自定义分析规则
- **数据可视化**: 股票价格走势图、财务指标图表等

#### 2.4.2 主题筛选模块
- **主题/行业选择**: 选择感兴趣的主题或行业
- **筛选条件设置**: 设置多条件筛选
- **排序设置**: 设置排序规则
- **结果列表展示**: 展示筛选后的股票列表

#### 2.4.3 场景分析模块
- **场景/新闻输入**: 输入场景描述或新闻内容
- **实体识别结果**: 展示识别的关键实体
- **供应链关系图**: 可视化展示供应链关系
- **企业信息列表**: 展示相关企业信息和标签

## 3. Data Flow

### 3.1 单股票分析数据流程
```
1. 用户在前端输入股票代码，请求分析
2. API层接收请求，调用单股票分析引擎
3. 分析引擎从akshare获取股票数据
4. 分析引擎根据用户规则执行分析
5. 分析引擎生成投资价值和风险评估结果
6. 结果存储到数据库
7. API层返回结果给前端
8. 前端展示分析结果
```

### 3.2 主题/行业筛选数据流程
```
1. 用户在前端选择主题/行业，设置筛选条件
2. API层接收请求，调用主题筛选引擎
3. 筛选引擎从数据库获取相关股票数据
4. 筛选引擎根据条件执行筛选和排序
5. 生成筛选结果列表
6. API层返回结果给前端
7. 前端展示筛选结果
```

### 3.3 场景/新闻分析数据流程
```
1. 用户在前端输入场景或新闻内容
2. API层接收请求，调用场景分析引擎
3. 场景分析引擎调用NLP模块进行文本分析
4. 识别关键实体，构建供应链关系
5. 查询企业上市状态和股权结构
6. 生成分析结果
7. API层返回结果给前端
8. 前端展示场景分析结果和供应链关系图
```

## 4. API Design

### 4.1 单股票分析API

#### 4.1.1 获取股票基本信息
- **URL**: `/api/stock/{code}`
- **Method**: GET
- **Path Parameters**: 
  - `code`: 股票代码
- **Response**: 
  ```json
  {
    "code": "000001",
    "name": "平安银行",
    "industry": "银行业",
    "market": "深交所",
    "list_date": "1991-04-03",
    "total_share": 194059180000,
    "float_share": 194059180000
  }
  ```

#### 4.1.2 执行股票分析
- **URL**: `/api/stock/{code}/analysis`
- **Method**: POST
- **Path Parameters**: 
  - `code`: 股票代码
- **Request Body**: 
  ```json
  {
    "rules": ["valuation", "growth", "financial_health"]
  }
  ```
- **Response**: 
  ```json
  {
    "code": "000001",
    "name": "平安银行",
    "analysis_date": "2025-12-25",
    "investment_value": {
      "score": 8.5,
      "factors": {
        "valuation": 8.0,
        "growth": 9.0,
        "financial_health": 8.5
      }
    },
    "risk_assessment": {
      "score": 3.5,
      "factors": {
        "market_risk": 3.0,
        "industry_risk": 4.0,
        "company_risk": 3.5
      }
    }
  }
  ```

### 4.2 主题/行业筛选API

#### 4.2.1 获取主题相关股票
- **URL**: `/api/themes/{theme}/stocks`
- **Method**: GET
- **Path Parameters**: 
  - `theme`: 主题名称
- **Query Parameters**: 
  - `filters`: 筛选条件（JSON格式）
  - `sort_by`: 排序字段
  - `sort_order`: 排序方向（asc/desc）
- **Response**: 
  ```json
  {
    "theme": "AI",
    "total_count": 120,
    "stocks": [
      {
        "code": "002230",
        "name": "科大讯飞",
        "industry": "计算机应用",
        "market": "深交所",
        "pe": 85.2,
        "roe": 9.5,
        "market_cap": 120000000000
      },
      // 更多股票...
    ]
  }
  ```

### 4.3 场景分析API

#### 4.3.1 分析场景或新闻
- **URL**: `/api/scenario/analyze`
- **Method**: POST
- **Request Body**: 
  ```json
  {
    "content": "英伟达发布最新GPU产品，性能提升50%",
    "language": "zh"
  }
  ```
- **Response**: 
  ```json
  {
    "entities": ["英伟达", "GPU"],
    "related_companies": [
      {
        "name": "英伟达",
        "is_listed": true,
        "ticker": "NVDA",
        "exchange": "NASDAQ",
        "relation_type": "core",
        "supply_chain_role": "manufacturer"
      },
      {
        "name": "台积电",
        "is_listed": true,
        "ticker": "TSM",
        "exchange": "NYSE",
        "relation_type": "direct_supply",
        "supply_chain_role": "manufacturing_partner"
      },
      {
        "name": "ASML",
        "is_listed": true,
        "ticker": "ASML",
        "exchange": "Euronext",
        "relation_type": "indirect_supply",
        "supply_chain_role": "equipment_provider"
      },
      // 更多企业...
    ]
  }
  ```

## 5. Database Design

### 5.1 MySQL数据库表结构

#### 5.1.1 股票基本信息表（stock_basic）
| 字段名 | 数据类型 | 描述 |
|--------|----------|------|
| id | INT | 主键ID |
| code | VARCHAR(20) | 股票代码 |
| name | VARCHAR(50) | 股票名称 |
| industry | VARCHAR(50) | 行业 |
| market | VARCHAR(20) | 市场（深交所/上交所等） |
| list_date | DATE | 上市日期 |
| total_share | BIGINT | 总股本 |
| float_share | BIGINT | 流通股本 |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

#### 5.1.2 股票财务数据表（stock_finance）
| 字段名 | 数据类型 | 描述 |
|--------|----------|------|
| id | INT | 主键ID |
| stock_id | INT | 股票ID（外键） |
| report_date | DATE | 报告日期 |
| pe | FLOAT | 市盈率 |
| pb | FLOAT | 市净率 |
| roe | FLOAT | 净资产收益率 |
| revenue | BIGINT | 营业收入 |
| profit | BIGINT | 净利润 |
| debt_ratio | FLOAT | 资产负债率 |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

#### 5.1.3 主题表（theme）
| 字段名 | 数据类型 | 描述 |
|--------|----------|------|
| id | INT | 主键ID |
| name | VARCHAR(50) | 主题名称 |
| description | TEXT | 主题描述 |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

#### 5.1.4 股票主题关联表（stock_theme）
| 字段名 | 数据类型 | 描述 |
|--------|----------|------|
| id | INT | 主键ID |
| stock_id | INT | 股票ID（外键） |
| theme_id | INT | 主题ID（外键） |
| created_at | DATETIME | 创建时间 |

#### 5.1.5 公司信息表（company）
| 字段名 | 数据类型 | 描述 |
|--------|----------|------|
| id | INT | 主键ID |
| name | VARCHAR(100) | 公司名称 |
| is_listed | BOOLEAN | 是否上市 |
| ticker | VARCHAR(20) | 股票代码（如果上市） |
| exchange | VARCHAR(50) | 交易所（如果上市） |
| industry | VARCHAR(50) | 行业 |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

#### 5.1.6 供应链关系表（supply_chain）
| 字段名 | 数据类型 | 描述 |
|--------|----------|------|
| id | INT | 主键ID |
| upstream_company_id | INT | 上游公司ID（外键） |
| downstream_company_id | INT | 下游公司ID（外键） |
| relation_type | VARCHAR(20) | 关系类型（direct/indirect） |
| description | TEXT | 关系描述 |
| created_at | DATETIME | 创建时间 |

### 5.2 MongoDB集合结构

#### 5.2.1 新闻集合（news）
```json
{
  "_id": ObjectId("..."),
  "title": "英伟达发布最新GPU产品",
  "content": "英伟达今日发布了最新一代GPU产品，性能提升50%...",
  "publish_date": ISODate("2025-12-25T08:00:00Z"),
  "source": "科技新闻网",
  "entities": ["英伟达", "GPU", "人工智能"],
  "created_at": ISODate("2025-12-25T08:00:00Z")
}
```

#### 5.2.2 分析结果集合（analysis_results）
```json
{
  "_id": ObjectId("..."),
  "stock_code": "000001",
  "analysis_date": ISODate("2025-12-25T10:00:00Z"),
  "investment_value": {
    "score": 8.5,
    "factors": {...}
  },
  "risk_assessment": {
    "score": 3.5,
    "factors": {...}
  },
  "created_at": ISODate("2025-12-25T10:00:00Z")
}
```

#### 5.2.3 场景分析结果集合（scenario_analysis）
```json
{
  "_id": ObjectId("..."),
  "input_content": "英伟达发布最新GPU产品...",
  "analysis_date": ISODate("2025-12-25T11:00:00Z"),
  "entities": ["英伟达", "GPU"],
  "related_companies": [...],
  "created_at": ISODate("2025-12-25T11:00:00Z")
}
```

## 6. UI/UX Design

### 6.1 界面设计原则
- **简洁直观**: 界面设计简洁，操作流程直观
- **响应式设计**: 适配不同屏幕尺寸
- **数据可视化**: 使用图表直观展示数据
- **用户友好**: 提供清晰的操作指引和帮助信息
- **性能优化**: 确保界面加载和操作流畅

### 6.2 主要界面布局

#### 6.2.1 股票分析界面
- **顶部导航栏**: 系统名称、功能模块导航
- **左侧菜单**: 股票查询、规则设置、历史记录
- **主内容区**: 
  - 股票基本信息卡片
  - 投资价值评分和指标
  - 风险评估和风险因素
  - 价格走势图和财务指标图表

#### 6.2.2 主题筛选界面
- **顶部导航栏**: 系统名称、功能模块导航
- **左侧菜单**: 主题列表、行业列表、筛选条件
- **主内容区**: 
  - 主题/行业选择面板
  - 筛选条件设置面板
  - 排序设置面板
  - 股票列表和关键指标

#### 6.2.3 场景分析界面
- **顶部导航栏**: 系统名称、功能模块导航
- **左侧菜单**: 场景输入、历史分析、帮助
- **主内容区**: 
  - 场景/新闻输入框
  - 实体识别结果展示
  - 供应链关系图
  - 企业信息列表和标签

## 7. Security Considerations

### 7.1 数据安全
- **数据加密**: 敏感数据在传输和存储过程中加密
- **访问控制**: 基于角色的访问控制（RBAC）
- **数据备份**: 定期备份数据库，确保数据安全

### 7.2 API安全
- **API认证**: 使用JWT进行API认证
- **请求限流**: 防止API滥用
- **输入验证**: 严格验证API输入，防止注入攻击
- **CORS配置**: 合理配置跨域资源共享

### 7.3 系统安全
- **防火墙**: 配置防火墙，限制不必要的访问
- **漏洞扫描**: 定期进行系统漏洞扫描
- **日志监控**: 记录系统操作日志，便于审计和问题排查
- **更新维护**: 及时更新系统和依赖库，修复安全漏洞

## 8. Deployment Architecture

### 8.1 开发环境
- **操作系统**: Linux/macOS
- **Python版本**: 3.8+
- **数据库**: MySQL 8.0+, MongoDB 4.4+
- **开发工具**: VS Code, PyCharm

### 8.2 生产环境
- **服务器**: Linux服务器集群
- **Web服务器**: Nginx（反向代理、负载均衡）
- **应用服务器**: Gunicorn（运行Flask应用）
- **数据库**: 
  - MySQL主从复制
  - MongoDB副本集
- **缓存**: Redis（提高性能）
- **监控**: Prometheus + Grafana（系统监控）
- **日志管理**: ELK Stack（日志收集和分析）

### 8.3 部署流程
1. 代码提交到版本控制系统（Git）
2. CI/CD流水线自动测试代码
3. 构建Docker镜像
4. 部署到测试环境进行测试
5. 部署到生产环境
6. 监控系统运行状态

## 9. Scalability Plan

### 9.1 水平扩展
- **应用服务器**: 使用Docker容器化部署，支持水平扩展
- **数据库**: 
  - MySQL：分库分表
  - MongoDB：分片集群
- **缓存**: Redis集群

### 9.2 性能优化
- **数据缓存**: 对频繁访问的数据进行缓存
- **异步处理**: 使用消息队列处理耗时任务
- **查询优化**: 优化数据库查询，添加适当索引
- **负载均衡**: 分发请求到多个服务器

### 9.3 功能扩展
- **支持更多数据源**: 扩展支持更多股票数据源
- **添加更多分析指标**: 支持更多投资价值和风险指标
- **增强NLP能力**: 提升文本分析和实体识别精度
- **添加机器学习模型**: 使用机器学习提升分析准确性
- **支持多语言**: 扩展支持中英文等多语言

## 10. Implementation Plan

### 10.1 阶段一：核心功能实现
- 数据层：实现akshare数据源接入
- 业务逻辑层：实现单股票分析引擎
- API层：实现Stock API
- 前端：实现股票分析界面

### 10.2 阶段二：扩展功能实现
- 业务逻辑层：实现主题筛选引擎
- API层：实现Theme API
- 前端：实现主题筛选界面

### 10.3 阶段三：高级功能实现
- 业务逻辑层：实现场景分析引擎和NLP分析模块
- API层：实现Scenario API
- 前端：实现场景分析界面

### 10.4 阶段四：优化和完善
- 性能优化
- 安全加固
- 界面优化
- 文档完善
- 系统测试

## 11. Testing Strategy

### 11.1 单元测试
- 测试各个模块的功能正确性
- 使用pytest进行Python代码测试
- 测试覆盖率目标：≥ 80%

### 11.2 集成测试
- 测试模块之间的集成
- 测试API接口的正确性
- 测试数据库操作的正确性

### 11.3 系统测试
- 测试整个系统的功能完整性
- 测试系统的性能和稳定性
- 测试边界情况和异常处理

### 11.4 用户验收测试
- 邀请用户参与测试
- 收集用户反馈
- 验证系统是否满足用户需求

## 12. Documentation

### 12.1 API文档
- 使用Swagger/OpenAPI生成API文档
- 包含API端点、参数、响应格式等
- 提供API测试功能

### 12.2 系统文档
- 系统架构文档
- 数据库设计文档
- 部署指南
- 操作手册

### 12.3 开发文档
- 代码注释
- 开发规范
- 版本更新日志

## 13. Future Enhancements

### 13.1 功能增强
- 智能投资建议：基于机器学习提供个性化投资建议
- 实时数据推送：使用WebSocket提供实时行情和新闻推送
- 回测功能：支持用户回测投资策略
- 社交功能：用户可以分享分析结果和投资观点

### 13.2 技术升级
- 微服务架构：将系统拆分为微服务
- 大数据处理：使用Spark处理大规模数据
- 人工智能：增强机器学习和深度学习能力
- 区块链技术：使用区块链确保数据不可篡改

### 13.3 生态扩展
- API开放平台：允许第三方接入系统
- 插件系统：支持用户开发和使用插件
- 移动应用：开发iOS和Android移动应用